Include "MapBasic.def"
include "Menu.def"
include "C:\Users\crbk01\Desktop\WhenOffline\MapInfoTabToCsv\CommonLib\commonLib1.def"


Declare Sub Main
Declare sub processor_1Pre

Declare sub DO1_1_genPathTab
Declare sub DO1_3_GenFasWithAdr
Declare sub DO1_4_prepRenMel
Declare sub DO1_4_prepRenNor
Declare sub DO1_4_prepRenS�d
Declare sub DO1_5_reningIhopslagen
Declare sub DO1_8_prepareSweref
Declare sub DO1_9_egnEnskWSpatFas
Declare sub DO1_10_enskiltIhopslagen
Declare sub DO1_11_prepareSocken
declare sub do6_8_SlamDisp 


global 
G_reningsObjekt() as reningsObjekt , G_swerefObjekt() as swerefObjekt, G_EnskiltObjekt() as EnskiltObjekt, 
G_workDir,G_socken as string,
 G_rebuild,G_debugg as logical, G_anv�ndaReningar(),G_ProgressRange,G_Progress,G_senastObjectID, G_senastTid,G_starttime as integer


Sub Main()
	G_debugg = true G_rebuild = false 
	G_senastTid = 0 
	G_socken = "" 
	
onError goto processor_1Pre G_ProgressRange = 8 G_Progress = 0 G_starttime = timer() ProgressBar "processor_1Pre...." & G_ProgressRange & " items" Calling processor_1Pre Range G_ProgressRange onError goto 0

exit sub

processor_1Pre: print "processor_1PreError" print error$()	    end program

End Sub

sub processor_1Pre
		
	'grundtabeller
	'Fastighetskikt med adress	
	''egna reningstabeller med spatial fastighet
			'egna EnskiltTabeller med spatial fastighet
					'egen swereftabell med spatial fastighet och index
	DO case G_Progress
	case 1
		'call DO1_1_genPathTab
		'call insertInitialTables()
		call DO1_3_GenFasWithAdr	
		call DO1_4_prepRenS�d
		if G_rebuild then print 1 end if
	case 2 
		call DO1_4_prepRenNor
		if G_rebuild then print 2 end if
	case 3
		call DO1_4_prepRenMel
		if G_rebuild then print 3 end if
	case 4
		call DO1_5_reningIhopslagen
		if G_rebuild then print 4 end if
	case 5
		call DO1_8_prepareSweref
		if G_rebuild then print 5 end if
	case 6
		call DO1_9_egnEnskWSpatFas
		if G_rebuild then print 6 end if
	case 7
		call DO1_10_enskiltIhopslagen
		call DO6_8_SlamDisp 'requiered at this step
		if G_rebuild then print 7 end if
	case 8
		call DO1_11_prepareSocken
		if G_rebuild then print 8 end if
	end case
	
	call increment(G_Progress,G_ProgressRange,G_starttime)
		
End Sub


sub DO1_1_genPathTab
	dim tempstring as string tempstring = "PathTABLE" if IsTableOpen(tempstring) then close table "pathTable" end if	
		CREATE TABLE PathTABLE (tableName Char(40),tablePath Char(256),alternative Char(40)) File TempFileName$("")

end sub

sub DO1_3_GenFasWithAdr

		dim tempstring as string
		tempString = applicationDirectory$() & "fastighet_ytaAd.tab"
		if(not(FileExists(tempString))) then
			print "rebuilding fastighet_ytaAd"
			dim tableNames(1) as string
			redim tableNames(2)
			
			tablenames(1) = "fastighet_ytaORg"
			tablenames(2) = "Adresspunkter"
						
			call tableOpener(tablenames)

			Create Table "FaMedAdrPunkt" (KIR Char(40),ADRESS Char(105),POSTNR Char(9),POSTORT Char(105),FASTIGHET Char(54),FNR Integer) file tempString TYPE NATIVE Charset "WinDOwsLatin1"
			Create Map For FaMedAdrPunkt CoordSys Earth Projection 8, 33, "m", 18.75, 0, 1, 150000, 0 Bounds (-8099143.95363, -10001965.7294) (8399143.95363, 10001965.7294)
			Insert Into FaMedAdrPunkt (KIR, FASTIGHET,FNR) Select COL2, COL12, Col1  From fastighet_ytaORg DropIndex Auto
			Add Column "FaMedAdrPunkt" (POSTORT )From Adresspunkter Set To POSTORT Where within
			Add Column "FaMedAdrPunkt" (POSTnr )From Adresspunkter Set To POSTnr Where within
			Add Column "FaMedAdrPunkt" (ADRESS )From Adresspunkter Set To ADRESS Where within

			select * from FaMedAdrPunkt where adress = "" into TomtFaMedAdrPunkt

			Add Column "TomtFaMedAdrPunkt" (ADRESS )From Adresspunkter Set To ADRESS Where COL6 = COL3 
			Add Column "TomtFaMedAdrPunkt" (POSTORT )From Adresspunkter Set To POSTORT Where COL6 = COL3 
			Add Column "TomtFaMedAdrPunkt" (POSTnr )From Adresspunkter Set To POSTnr Where COL6 = COL3 

			commit table FaMedAdrPunkt
			Create Index On FaMedAdrPunkt(kir)
			commit table FaMedAdrPunkt
			
			close table fastighet_ytaORg
			close table Adresspunkter		
			close table FaMedAdrPunkt
		end if
		insert into Pathtable (tablePath,TableName) values (Tempstring, "fastighet_yta")

end sub

sub DO1_4_prepRenS�d
		dim tempstring as string 
		dim tableNames(1) as string
		redim tableNames(2)
		
		tempstring = ApplicationDirectory$() & "Rening_S�dra.TAB"
		
		if G_rebuild then
			tablenames(2) = "fastighet_yta"
			tablenames(1) = "Rening_S�draNoIndex"		
			call tableOpener(tablenames)	
	
			select * from tablenames(1) into "Rening_S�dra"
			commit table Rening_S�dra  As tempstring TYPE NATIVE Charset "WinDOwsLatin1" Interactive
 			close table Rening_S�dra
 			open table tempstring
			Alter Table Rening_S�dra ( add SpatialFastighet Char(40), SpatialShift Char(40)  )
			Add Column "Rening_S�dra" (SpatialFastighet )From fastighet_yta Set To kir Where contains
			Add Column "Rening_S�dra" (SpatialShift)From fastighet_yta Set To Fastighet Where contains
			commit table Rening_S�dra
			Alter Table "Rening_S�dra" ( order Fastighet_rening,Antal_hush�ll_rening,Reningstyp,Storlek_m2,Beslut_datum,Utf�rd_datum,Kommentarer,Anslutna_fastigheter_1,Anslutna_fastigheter_2,Anslutna_fastigheter_3,Anslutna_fastigheter_4,Anslutna_fastigheter_5,Anslutna_fastigheter_6,Anslutna_fastigheter_7,Anslutna_fastigheter_8,Anslutna_fastigheter_9,Anslutna_fastigheter_10,SpatialFastighet,SpatialShift)
			call tableCloser(tablenames())
		end if
		
		insert into Pathtable (tablePath,TableName) values (Tempstring, "Rening_S�dra")
			
end sub


sub DO1_4_prepRenNor


		dim tempstring as string 
		dim tableNames(1) as string
		redim tableNames(2)
			tempstring = ApplicationDirectory$() & "Rening_Norra.TAB"
		
		if G_rebuild then
			tablenames(1) = "fastighet_yta"		
			tablenames(2) = "Rening_NorraNoIndex"
			call tableOpener(tablenames)	
			select * from tablenames(2) into "Rening_Norra"
			commit table Rening_Norra  As tempstring TYPE NATIVE Charset "WinDOwsLatin1" Interactive
			close table Rening_Norra
 			open table tempstring
			Alter Table Rening_Norra (add SpatialFastighet Char(40), SpatialShift Char(40)  )
			Add Column "Rening_Norra" (SpatialFastighet )From fastighet_yta Set To kir Where contains
			Add Column "Rening_Norra" (SpatialShift)From fastighet_yta Set To Fastighet Where contains
			commit table Rening_Norra
			Alter Table "Rening_Norra" ( order Fastighet_rening,Antal_hush�ll_rening,Reningstyp,Storlek_m2,Beslut_datum,Utf�rd_datum,Kommentarer,Anslutna_fastigheter_1,Anslutna_fastigheter_2,Anslutna_fastigheter_3,Anslutna_fastigheter_4,Anslutna_fastigheter_5,Anslutna_fastigheter_6,Anslutna_fastigheter_7,Anslutna_fastigheter_8,Anslutna_fastigheter_9,Anslutna_fastigheter_10,SpatialFastighet,SpatialShift)
			call tableCloser(tablenames())
		end if
		insert into Pathtable (tablePath,TableName) values (Tempstring, "Rening_Norra")
end sub

sub DO1_4_prepRenMel
		dim tempstring as string 
		dim tableNames(1) as string
		redim tableNames(4)
		tempstring = ApplicationDirectory$() & "Rening_Mellersta.TAB"
		
		if G_rebuild then
			tablenames(4) = "fastighet_yta"		
			tablenames(3) = "Rening_MellerstaNoIndex"							
			call tableOpener(tablenames)	
			select * from tablenames(3) into "Rening_Mellersta"		
			
			commit table Rening_Mellersta  As tempstring TYPE NATIVE Charset "WinDOwsLatin1" Interactive
			close table Rening_Mellersta
 			open table tempstring

			Alter Table Rening_Mellersta ( add SpatialFastighet Char(40), SpatialShift Char(40) )
			Add Column "Rening_Mellersta" (SpatialFastighet)From fastighet_yta Set To kir Where contains
			Add Column "Rening_Mellersta" (SpatialShift)From fastighet_yta Set To Fastighet Where contains
			commit table Rening_Mellersta
			Alter Table "Rening_Mellersta" ( order Fastighet_rening,Antal_hush�ll_rening,Reningstyp,Storlek_m2,Beslut_datum,Utf�rd_datum,Kommentarer,Anslutna_fastigheter_1,Anslutna_fastigheter_2,Anslutna_fastigheter_3,Anslutna_fastigheter_4,Anslutna_fastigheter_5,Anslutna_fastigheter_6,Anslutna_fastigheter_7,Anslutna_fastigheter_8,Anslutna_fastigheter_9,Anslutna_fastigheter_10,SpatialFastighet,SpatialShift)
			
			call tableCloser(tablenames())
		end if
		insert into Pathtable (tablePath,TableName) values (Tempstring, "Rening_Mellersta")
end sub
 
sub DO1_5_reningIhopslagen
dim tablenames(3) as string

tablenames(1) = "Rening_Mellersta"
tablenames(2) = "rening_Norra"
tablenames(3) = "rening_S�dra"
		call tableOpener(tablenames)	
		dim tempstring as string tempstring = CreateTable_reningIhopslagen()
		call insertXintoYtableWhereXcolLessThaYcol("rening_mellersta","reningIhopslagen")
		call insertXintoYtableWhereXcolLessThaYcol("rening_Norra","reningIhopslagen")
		call insertXintoYtableWhereXcolLessThaYcol("rening_S�dra","reningIhopslagen")
		Commit table reningIhopslagen
		
		call UpdateIndex("reningIhopslagen")'already commits
		insert into Pathtable (tablePath,TableName) values (Tempstring, "reningIhopslagen")	
		call tableCloserAndCommiter(tableNames)
	end sub

sub DO1_8_prepareSweref
		dim tableNames(1) as string
		redim tableNames(2)
		dim tempstring as string tempstring = ApplicationDirectory$() & "Fastigheter_sweref.TAB"
		
		if G_rebuild then		
			tablenames(1) = "Fastigheter_swerefNoIndex"
			tablenames(2) = "fastighet_yta"
			call tableOpener(tablenames)
			select * from tablenames(1) into "Fastigheter_sweref"
			commit table Fastigheter_sweref  As tempstring TYPE NATIVE Charset "WinDOwsLatin1" Interactive
			close table Fastigheter_sweref
 			open table tempstring
			call UpdateIndex("Fastigheter_sweref")
			Alter Table Fastigheter_sweref (add SpatialFastighet Char(40), SpatialShift Char(40))
			Commit table Fastigheter_sweref
			
			Add Column "Fastigheter_sweref" (SpatialFastighet)From fastighet_yta Set To kir Where contains
			Add Column "Fastigheter_sweref" (SpatialShift)From fastighet_yta Set To fastighet Where contains
			Commit table Fastigheter_sweref
		end if
		insert into Pathtable (tablePath,TableName) values (tempstring, "Fastigheter_sweref")

end sub

sub DO1_9_egnEnskWSpatFas
		dim tableNames(1) as string
		redim tableNames(4)
				
		dim tempstring1,tempstring2,tempstring3 as string ,tempAlias as alias
	
		tempstring1 = ApplicationDirectory$() & "Enskilt_avlopp_S�dra.TAB"
		tempstring2 = ApplicationDirectory$() & "Enskilt_avlopp_Norra.TAB"
		tempstring3 = ApplicationDirectory$() & "Enskilt_avlopp_Mellersta.TAB"
		
		if G_rebuild then
			tablenames(1) = "Enskilt_avlopp_S�draNoIndex"
			tablenames(2) = "Enskilt_avlopp_NorraNoIndex"
			tablenames(3) = "Enskilt_avlopp_MellerstaNoIndex"
			tablenames(4) = "fastighet_yta"
			onError goto e414
			call tableOpener(tablenames)
			onError goto 0		
			
			onError goto e418
				tempAlias = tablenames(1) call commitCloseAndReopen(tempAlias,tempstring1)
				tempAlias = tablenames(2) call commitCloseAndReopen(tempAlias,tempstring2)
				tempAlias = tablenames(3) call commitCloseAndReopen(tempAlias,tempstring3)
			onError goto 0

onError goto e424
			call openSingleTable("fastighet_yta")
onError goto 0

onError goto e428		
			Alter Table Enskilt_avlopp_S�draNoIndex ( add SpatialFastighet Char(40), SpatialShift Char(40) )
			Add Column "Enskilt_avlopp_S�draNoIndex" (SpatialFastighet )From fastighet_yta Set To kir Where contains
			Add Column "Enskilt_avlopp_S�draNoIndex" (SpatialShift )From fastighet_yta Set To Fastighet Where contains
onError goto 0

onError goto e434
			Alter Table Enskilt_avlopp_NorraNoIndex ( add SpatialFastighet Char(40), SpatialShift Char(40)  )
			Add Column "Enskilt_avlopp_NorraNoIndex" (SpatialFastighet )From fastighet_yta Set To kir Where contains
			Add Column "Enskilt_avlopp_NorraNoIndex" (SpatialShift) From fastighet_yta Set To Fastighet Where contains
onError goto 0

onError goto e440
			Alter Table Enskilt_avlopp_MellerstaNoIndex (add SpatialFastighet Char(40), SpatialShift Char(40) )
			Add Column "Enskilt_avlopp_MellerstaNoIndex" (SpatialFastighet )From fastighet_yta Set To kir Where contains
			Add Column "Enskilt_avlopp_MellerstaNoIndex" (SpatialShift)From fastighet_yta Set To Fastighet Where contains
onError goto 0
onError goto e445
			'end program
			call tableCloserAndCommiter(tableNames)
			onError goto 0
		end if
	onError goto e450
		insert into Pathtable (tablePath,TableName) values (Tempstring1, "Enskilt_avlopp_S�dra")
		insert into Pathtable (tablePath,TableName) values (Tempstring2, "Enskilt_avlopp_Norra")
		insert into Pathtable (tablePath,TableName) values (Tempstring3, "Enskilt_avlopp_Mellersta")
	onError goto 0


exit sub

 e414: print " e414:" & " " & error$()
 e418: print " e418:" & " " & error$() 
 e424: print " e424:" & " " & error$() 
 e428: print " e428:" & " " & error$() 
 e434: print " e434:" & " " & error$() 
 e440: print " e440:" & " " & error$() 
 e445: print " e445:" & " " & error$() 
 e450: print " e450:" & " " & error$() 



ErRRZ:
		print "[ErRRZ] failed to commit table Enskilt_avlopp_S�dra  As " & tempstring1 
		end program	
ErRRZ2:
		print "[ErRRZ] failed to commit table Enskilt_avlopp_Norra  As " & tempstring2 
		end program	
ErRRZ3:
		print "[ErRRZ] failed to commit table Enskilt_avlopp_Mellersta  As " & tempstring3 
		end program	
end sub

sub DO1_10_enskiltIhopslagen
		
		dim tempstring as string tempstring = CreateTable_enskiltIhopslagen()
		dim tableNames(1) as string
		redim tableNames(3)
	
		tablenames(1) = "Enskilt_avlopp_S�dra"
		tablenames(2) = "Enskilt_avlopp_Norra"
		tablenames(3) = "Enskilt_avlopp_Mellersta"
		
		call tableOpener(tablenames)
	
		call insertCommonColumnsFromTableXintoY("Enskilt_avlopp_mellersta","EnskiltIhopslagen")
		call insertCommonColumnsFromTableXintoY("Enskilt_avlopp_Norra","EnskiltIhopslagen")
		call insertCommonColumnsFromTableXintoY("Enskilt_avlopp_S�dra","EnskiltIhopslagen")
		Commit table EnskiltIhopslagen
				
		call UpdateIndex("EnskiltIhopslagen")'already commits
		insert into Pathtable (tablePath,TableName) values (Tempstring, "EnskiltIhopslagen")
		call tableCloserAndCommiter(tableNames)
end sub

sub DO1_11_prepareSocken
		'figure out what wee need to DO whit this function 
		'lets say we generate a necessary table for processor_2SockenRead
		'sockenTabell m�ste skapas, men denna skall vara tom
		'varf�r beh�ver sockenX, och 
		'varf�r beh�ver vi �nns skapa socknarOfiltrerade?
		'verkar som att processor_2SockenRead beh�ver socknarOfiltrerade,
		'd�per om den s� att det f�rhoppningsvis inte sprider sig vidare

		dim tempstring,tablenames(3) as string	,tempAlias as alias
'	
		tempstring = "socknarOfiltrerade"
		if G_rebuild then
			print "rebuilding socknarOfiltrerade"
			dim tempBool as logical call openSingleTable("fastighet_yta") 

			tempstring = createTemporaryTableAnDOpen("""sockenTabelx"" (sockenX Char(254))")
			insert into sockentabelx Select Cond(left$(KIR,InStr(1,KIR," ",)-1), "allm�nt","", "outrett", "", right$(left$(KIR,InStr(1,KIR," ",)-1),1) = "S" AND left$(KIR,InStr(1,KIR," ",)-1) <> "burs","", left$(KIR,InStr(1,KIR," ",)-1)) from fastighet_yta
			select * from sockenTabelx where col1 <> "" group by col1 order by col1 into socknarOfiltrerade
			commit table socknarOfiltrerade as ApplicationDirectory$() & "socknarOfiltrerade.tab"
			close table sockenTabelx
			call openSingleTable("socknarOfiltrerade")
		end if
'		
'		
'		select * from Sockentabell where col1 <> "" group by col1 order by col1 into socknarOfiltrerade
'		redim tablenames(2) tablenames(1) = "EnskiltIhopslagen" tablenames(2) = "reningIhopslagen" call tableOpener(tablenames)	
		tempstring = createTemporaryTableAnDOpen("""sockenTabell"" (sockenX Char(254))")
end sub


sub do6_8_SlamDisp 	
		dim tableNames(1) as string 
		redim tableNames(2)
		tableNames(1) = "Lokalt_omh�ndertagande_slam"
		tablenames(2) = "fastighet_yta"
		call tableOpener(tablenames)
		
		Select fastighet_yta.KIR, Lokalt_omh�ndertagande_slam.Diarienr, Lokalt_omh�ndertagande_slam.Beslutsdatum from Lokalt_omh�ndertagande_slam, fastighet_yta where Lokalt_omh�ndertagande_slam.Obj Within fastighet_yta.Obj into slam
		Alter Table "EnskiltIhopslagen" ( add SlamDispDat Date )
		Commit table EnskiltIhopslagen
		Add Column "EnskiltIhopslagen" (SlamDispDat )From Lokalt_omh�ndertagande_slam Set To Beslutsdatum Where COL17 = COL1 
		Add Column "EnskiltIhopslagen" (Anteckningar )From slam Set To "[SlamDisp p�: " & DiarieNr & "] " & Anteckningar Where COL17 = COL1 
		Commit table EnskiltIhopslagen
end sub
